---
title: Usando el nuevo endpoint de Presencia en MS Graph API desde SPFx
slug: /revistas/numero-43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx
date: 27/02/2020
magazine: 43
author: Luis Ma√±ez
authorId: luis-manez
keywords: ['SharePoint Framework']
---





El pasado mes de diciembre, el equipo de Microsoft Graph, anunci√≥ la preview de un nuevo Endpoint de Presencia, que como pod√©is imaginar, nos va a proporcionar la informaci√≥n de Presencia de uno o varios usuarios. Pod√©is ver el anuncio en el siguiente vinculo:

[https://developer.microsoft.com/en-us/graph/blogs/microsoft-graph-presence-apis-are-now-available-in-public-preview/](https://developer.microsoft.com/en-us/graph/blogs/microsoft-graph-presence-apis-are-now-available-in-public-preview/)

Con este nuevo endpoint, podemos mostrar informaci√≥n de presencia en otras aplicaciones de negocio, o, como veremos en el ejemplo de este art√≠culo, en un sitio de SharePoint, usando un WebPart desarrollado con el SharePoint framework (SPFx). Pod√©is ver el resultado de esto en la siguiente imagen:

![Imagen 1.- Ejemplo de uso del EndPoint de presencia.](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image1.png)

**Llamando el Endpoint de Presencia desde Postman**

Antes de entrar en detalle con el c√≥digo de nuestro WebPart, vamos a ver c√≥mo tenemos que invocar el endpoint de presencia, y qu√© tipo de informaci√≥n nos va a retomar. Para ello, vamos a utilizar Postman.

Existen 2 endpoint de Presencia, el primero de ellos, nos va a dar la informaci√≥n de presencia de un usuario concreto, o nuestro propio usuario:

![](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image2.png)

El segundo, seguramente el que m√°s utilizaremos en nuestras aplicaciones, nos va a permitir sacar la informaci√≥n de presencia de un listado de usuarios.

![](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image3.png)

Para usar Postman con la MS Graph API, os recomiendo que utilic√©is la colecci√≥n de postman que el equipo de producto mantiene en el siguiente repositorio de GitHub:

[https://github.com/microsoftgraph/microsoftgraph-postman-collections](https://github.com/microsoftgraph/microsoftgraph-postman-collections)

Una de las peticiones de dicha colecci√≥n, nos permitir√° sacar un AccessToken para poder llamar a los diferentes endpoints, en nuestro caso los de presencia. En el readme del proyecto, ten√©is como pod√©is configurar el entorno de Postman, para poder obtener un AccessToken para vuestra Tenant de Office 365. B√°sicamente, necesitar√©is registrar una App en vuestro Azure Active Directory, crear un Secret, y dar permisos a la app para el endpoint de presencia:

![](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image4.png)

Una vez obtenido el AccessToken, ya podemos llamar al endpoint de presencia.

**Request / Response Informaci√≥n de Presencia del usuario logado**

Para obtener la informaci√≥n de presencia del usuario logado, haremos:‚Äã

![Imagen 2.- Como obtener la informaci√≥n de presencia del usuario logado.](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image5.png)

Como pod√©is ver en la imagen anterior, la respuesta con la informaci√≥n de presencia consiste en el Identificador del usuario, y dos campos m√°s:

- **Availability**: este es el t√≠pico: Away, Busy, etc. Seg√∫n la documentaci√≥n, los posibles valores a d√≠a de hoy son: Available, AvailableIdle, Away, BeRightBack, Busy, BusyIdle, DoNotDisturb, Offline, PresenceUnknown.
- **Activity**: Informaci√≥n adicional a la availability del usuario. Posibles valores: Available, Away, BeRightBack,Busy, DoNotDisturb, InACall, InAConferenceCall, Inactive,InAMeeting, Offline, OffWork,OutOfOffice, PresenceUnknown,Presenting, UrgentInterruptionsOnly.


**Request / Response Informaci√≥n de Presencia varios usuarios**

Para obtener la informaci√≥n de presencia de un listado de usuarios, debemos hacer un POST al endpoint /beta/communications/getPresencesByUserId, y enviar en el body la lista con los IDs de los usuarios.

![Imagen 3.- Respuesta con la informaci√≥n de presencia de varios usuarios.](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image6.png)

Si nos fijamos en la respuesta, vemos que obtenemos la misma informaci√≥n que con el endpoint anterior, pero para cada uno de los usuarios solicitados.

Nota: si en el listado de usuarios incluimos alg√∫n usuario que no existe en el directorio, lo que obtenemos como informaci√≥n de presencia es la availability y activity con valor "PresenceUnknown".

**Invocando al endpoint getPresencesByUserId desde un WebPart SPFx**

Ahora que ya tenemos claro el tipo de petici√≥n que debemos hacer para obtener la presencia de varios usuarios, y el tipo de informaci√≥n devuelta que tendremos, ya podemos llamar al endpoint desde SPFx, y mostrar sus resultados.

Para ello, al ser endpoint de MS Graph API, haremos uso del propio MSGraphClient proporcionado por el framework SPFx. Como lo que queremos es sacar la presencia de todos los usuarios que forman parte de un site de SharePoint, primero necesitamos sacar los usuarios de dicho site, tambi√©n llamando a Graph.

Antes de nada, en el OnInit del WebPart, utilizaremos el objeto msGraphClientFactory para obtener el MSGraphClient

![](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image7.png)

Dicho cliente ser√° pasado al componente de React, que har√° todo el trabajo üòä.

Primero obtendremos los miembros del site con el siguiente m√©todo:

![](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image8.png)

B√°sicamente llamamos a Graph, y el resultado lo metemos en un diccionario, para posteriormente, actualizar cada usuario del diccionario con su informaci√≥n de presencia.

Con cada usuario, componemos un array de IDs, y llamamos el endpoint para sacar su informaci√≥n de presencia:

![](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image9.png)

Finalmente, en el render del componente React, utilizamos el control Persona del Office fabric UI ([https://developer.microsoft.com/en-us/fabric#/controls/web/persona](https://developer.microsoft.com/en-us/fabric#/controls/web/persona)), que nos permite renderizar detalle de usuarios, y que adem√°s ya tiene algo para poder sacar la t√≠pica bolita con la availability del usuario sobre su avatar:

![](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image10.png)

Finalmente, la funci√≥n *\_fromPresenceAvailabilityToPersonaPresence*, hace un simple mapeo entre la informaci√≥n de availability que viene de la API, y las opciones que ofrece el componente Persona (que a d√≠a de hoy no tienen un mapeo uno a uno)

![](../../../images/numero43/usando-el-nuevo-endpoint-de-presencia-en-ms-graph-api-desde-spfx/image11.png)

Ten√©is todo el ejemplo completo en el repositorio de GitHub del PnP

[https://github.com/SharePoint/sp-dev-fx-WebParts/tree/master/samples/react-members-with-presence](https://github.com/SharePoint/sp-dev-fx-webparts/tree/master/samples/react-members-with-presence)

¬°Hasta el pr√≥ximo art√≠culo!



**Luis Ma√±ez** <br />
Cloud Architect en ClearPeople LTD <br />
 @luismanez <br />
 [https://medium.com/inherits-cloud](https://medium.com/inherits-cloud) 
 
import LayoutNumber from '../../../components/layout-article'
export default LayoutNumber
